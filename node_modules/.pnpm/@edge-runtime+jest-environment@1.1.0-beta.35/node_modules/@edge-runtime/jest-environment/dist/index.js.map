{"version":3,"file":"index.js","sourceRoot":"","sources":["../src/index.ts"],"names":[],"mappings":"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","sourcesContent":["import type { Config, Global } from '@jest/types'\nimport type { JestEnvironment } from '@jest/environment'\nimport { EdgeVM } from '@edge-runtime/vm'\nimport { installCommonGlobals } from 'jest-util'\nimport { LegacyFakeTimers, ModernFakeTimers } from '@jest/fake-timers'\nimport { ModuleMocker } from 'jest-mock'\n\ninterface Context {\n  [key: string | number]: any\n}\nexport = class EdgeEnvironment implements JestEnvironment<number> {\n  context: Context | null\n  fakeTimers: LegacyFakeTimers<number> | null\n  fakeTimersModern: ModernFakeTimers | null\n  global: Global.Global\n  moduleMocker: ModuleMocker | null\n\n  constructor(config: Config.ProjectConfig) {\n    const vm = new EdgeVM({\n      extend: (context) => {\n        context.global = context\n        context.Buffer = Buffer\n        return context\n      },\n      ...((config as any).projectConfig ?? config)?.testEnvironmentOptions\n    })\n\n    revealPrimitives(vm)\n    this.context = vm.context\n\n    const global = (this.global = Object.assign(\n      this.context,\n      config.testEnvironmentOptions\n    ) as any)\n\n    installCommonGlobals(global, config.globals)\n\n    this.moduleMocker = new ModuleMocker(global)\n\n    this.fakeTimers = new LegacyFakeTimers({\n      config,\n      global,\n      moduleMocker: this.moduleMocker,\n      timerConfig: {\n        idToRef: (id: number) => id,\n        refToId: (ref: number) => ref,\n      },\n    })\n\n    this.fakeTimersModern = new ModernFakeTimers({\n      config,\n      global,\n    })\n  }\n\n  async setup(): Promise<void> {}\n\n  async teardown(): Promise<void> {\n    if (this.fakeTimers != null) {\n      this.fakeTimers.dispose()\n    }\n    if (this.fakeTimersModern != null) {\n      this.fakeTimersModern.dispose()\n    }\n    this.context = null\n    this.fakeTimers = null\n    this.fakeTimersModern = null\n  }\n\n  exportConditions(): string[] {\n    return ['edge']\n  }\n\n  getVmContext(): Context | null {\n    return this.context\n  }\n}\n\n/**\n * Jest will access some primitives directly through vm.context so we must\n * make them available. We do this by redefining the property in the\n * context object.\n */\nfunction revealPrimitives(vm: EdgeVM<any>) {\n  ;[\n    'Array',\n    'ArrayBuffer',\n    'Atomics',\n    'BigInt',\n    'BigInt64Array',\n    'BigUint64Array',\n    'Boolean',\n    'DataView',\n    'Date',\n    'decodeURI',\n    'decodeURIComponent',\n    'encodeURI',\n    'encodeURIComponent',\n    'Error',\n    'EvalError',\n    'Float32Array',\n    'Float64Array',\n    'Function',\n    'Int8Array',\n    'Int16Array',\n    'Int32Array',\n    'Intl',\n    'isFinite',\n    'isNaN',\n    'JSON',\n    'Map',\n    'Math',\n    'Number',\n    'Object',\n    'parseFloat',\n    'parseInt',\n    'Promise',\n    'Proxy',\n    'RangeError',\n    'ReferenceError',\n    'Reflect',\n    'RegExp',\n    'Set',\n    'SharedArrayBuffer',\n    'String',\n    'Symbol',\n    'SyntaxError',\n    'TypeError',\n    'Uint8Array',\n    'Uint8ClampedArray',\n    'Uint16Array',\n    'Uint32Array',\n    'URIError',\n    'WeakMap',\n    'WeakSet',\n    'WebAssembly',\n  ].forEach((property) => {\n    vm.evaluate(`\n      Object.defineProperty(this, '${property}', {\n        configurable: false,\n        enumerable: false,\n        value: ${property},\n        writable: true,\n      })\n    `)\n  })\n}\n"]}